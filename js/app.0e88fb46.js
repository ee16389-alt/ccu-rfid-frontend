(function(){"use strict";var t={8157:function(t,e,i){var a=i(5471),s=function(){var t=this,e=t._self._c;return e("div",{attrs:{id:"app"}},[t.debugMode?e("div",{staticClass:"debug-toolbar"},[e("el-tag",{attrs:{type:"info",size:"small"}},[t._v("開發者工具")]),e("el-button",{attrs:{size:"mini",type:"success"},on:{click:function(e){t.currentView="RFIDLanding"}}},[t._v("長者端 (首頁)")]),e("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(e){t.currentView="Login"}}},[t._v("行政管理端")]),e("el-button",{attrs:{size:"mini"},on:{click:function(e){t.debugMode=!1}}},[t._v("隱藏工具列")])],1):t._e(),e("div",{staticClass:"container"},["RFIDLanding"===t.currentView?e("RFIDLanding",{on:{"scan-success":t.onScanSuccess}}):"ActivityMenu"===t.currentView?e("ActivityMenu",{attrs:{rfid_uid:t.selectedRfid},on:{"select-activity":t.onSelectActivity,"go-back":function(e){t.currentView="RFIDLanding"}}}):"Slideshow"===t.currentView?e("Slideshow",{attrs:{rfid_uid:t.selectedRfid,activityId:t.selectedActivityId},on:{"go-back":function(e){t.currentView="ActivityMenu"}}}):"Login"===t.currentView?e("Login",{on:{"login-success":function(e){t.currentView="ActivityList"}}}):"ActivityList"===t.currentView?e("ActivityList",{on:{"manage-activity":t.onManageActivity,"add-activity":t.onAddActivity}}):"ActivityManage"===t.currentView?e("ActivityManage",{attrs:{selectedActivity:t.activeActivityObject},on:{"go-back":function(e){t.currentView="ActivityList"},"go-screening":function(e){t.currentView="AIScreening"},"go-recognition":function(e){t.currentView="AIRecognition"}}}):"AIRecognition"===t.currentView?e("AIRecognitionView",{attrs:{activityId:t.selectedActivityId},on:{"go-back":function(e){t.currentView="ActivityManage"}}}):"AIScreening"===t.currentView?e("AIScreening",{attrs:{activityId:t.selectedActivityId},on:{"go-back":function(e){t.currentView="ActivityManage"}}}):"ElderList"===t.currentView?e("ElderList",{on:{"edit-elder":t.onEditElder,"add-elder":t.onAddElder}}):"ElderEdit"===t.currentView?e("ElderEdit",{attrs:{elderId:t.selectedResidentId},on:{"go-back":function(e){t.currentView="ElderList"}}}):e("p",{staticStyle:{"text-align":"center","margin-top":"50px"}},[e("i",{staticClass:"el-icon-loading"}),t._v(" 系統正在準備中... ")])],1),t.isAdminView?e("div",{staticClass:"admin-nav"},[e("el-button",{attrs:{icon:"el-icon-s-order"},on:{click:function(e){t.currentView="ActivityList"}}},[t._v("活動列表")]),e("el-button",{attrs:{icon:"el-icon-user-solid"},on:{click:function(e){t.currentView="ElderList"}}},[t._v("長者管理")]),e("el-button",{staticStyle:{color:"#F56C6C"},attrs:{type:"text"},on:{click:t.logout}},[t._v("安全登出")])],1):t._e()])},o=[],n=function(){var t=this,e=t._self._c;return e("div",{staticClass:"landing-container"},[e("div",{staticClass:"bg-glow"}),e("div",{staticClass:"content-box"},[e("h1",{staticClass:"main-title"},[t._v("回憶時光機")]),e("p",{staticClass:"sub-title"},[t._v("請輕碰感應卡，開啟您的專屬記憶")]),e("div",{staticClass:"rfid-icon-wrapper",class:{scanning:t.loading}},[e("div",{staticClass:"rfid-main-circle"},[e("div",{staticClass:"rfid-icon"},[e("i",{staticClass:"el-icon-bank-card",staticStyle:{"font-size":"90px"}}),t.loading?e("div",{staticClass:"scan-line"}):t._e()])]),e("div",{staticClass:"ripple"}),e("div",{staticClass:"ripple delay-1"})]),e("p",{staticClass:"status-text"},[e("i",{class:t.loading?"el-icon-loading":"el-icon-place"}),t._v(" "+t._s(t.loading?`正在讀取您的珍貴回憶... (${t.countdown}s)`:"等待感應中")+" ")]),e("el-button",{staticClass:"glass-start-button",attrs:{type:"warning",loading:t.loading,disabled:!t.hasToken},on:{click:t.handleStart}},[t._v(" "+t._s(t.loading?"請刷卡...":"開始感應")+" ")])],1),e("div",{staticClass:"footer-section"},[t._m(0),e("transition",{attrs:{name:"el-fade-in"}},[t.hasToken?t._e():e("div",{staticClass:"auth-warning"},[e("i",{staticClass:"el-icon-warning-outline"}),t._v(" 系統尚未授權，請聯絡管理員登入 ")])])],1),e("input",{directives:[{name:"model",rawName:"v-model",value:t.scanBuffer,expression:"scanBuffer"}],ref:"rfidInput",staticClass:"rfid-input",attrs:{type:"text",autocomplete:"off"},domProps:{value:t.scanBuffer},on:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:(e.preventDefault(),t.onScanComplete.apply(null,arguments))},input:function(e){e.target.composing||(t.scanBuffer=e.target.value)}}})])},r=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"footer-info"},[e("span",{staticClass:"dot"}),t._v(" 智慧 RFID 系統正在運作中 "),e("span",{staticClass:"dot"})])}],l={name:"RFIDLanding",data(){return{loading:!1,hasToken:!!localStorage.getItem("userToken"),scanBuffer:"",scanTimer:null,countdown:3,countdownTimer:null}},methods:{async handleStart(){const t=localStorage.getItem("userToken");t?(this.loading=!0,this.scanBuffer="",this.countdown=3,this.$nextTick(()=>{this.$refs.rfidInput&&this.$refs.rfidInput.focus()}),this.countdownTimer=setInterval(()=>{this.countdown>1&&this.countdown--},1e3),this.scanTimer=setTimeout(()=>{this.loading&&this.enterDemoMode()},3e3)):this.$message.error("【權限錯誤】請先由行政管理端完成登入驗證")},async onScanComplete(){clearTimeout(this.scanTimer),clearInterval(this.countdownTimer);const t=this.scanBuffer.trim();this.scanBuffer="",t?await this.processRfid(t):this.enterDemoMode()},async processRfid(t){try{const e=await this.$http.get(`/manager-api/rfid/${t}`);if(e.data.match&&e.data.match.length>0){const i=e.data.match[0];this.$notify({title:"感應成功",message:"subject"===i.type?`${i.name} 您好，歡迎回到時光機！`:`請觀賞 ${i.name} 活動相簿`,type:"success",position:"top-left"}),setTimeout(()=>{this.$emit("scan-success",{rfid:t,match:i,activities:e.data.activitys||[]})},1e3)}else this.$message.warning("查無此卡片資料，請聯絡管理員登記"),this.loading=!1}catch(e){console.warn("API 錯誤或未連線，轉入 Demo",e),this.enterDemoMode()}},enterDemoMode(){clearTimeout(this.scanTimer),clearInterval(this.countdownTimer),this.loading=!1,this.$message({message:"【Demo 模式】歡迎回來，唐伯虎先生！",type:"warning"}),setTimeout(()=>{this.$emit("scan-success",{rfid:"116A2434",match:{type:"subject",name:"唐伯虎",id:"9527"},activities:[]})},1200)}},beforeDestroy(){clearTimeout(this.scanTimer),clearInterval(this.countdownTimer)}},c=l,d=i(1656),u=(0,d.A)(c,n,r,!1,null,"61273ba6",null),h=u.exports,p=function(){var t=this,e=t._self._c;return e("div",{staticClass:"activity-menu-container"},[e("div",{staticClass:"header-playback"},[e("h1",{staticClass:"main-title"},[t._v("回憶照片牆")]),t.residentName?e("el-tag",{staticClass:"identity-tag",attrs:{type:"warning",effect:"dark"}},[e("i",{staticClass:"el-icon-user"}),t._v(" 歡迎："+t._s(t.residentName)+" ")]):t._e(),e("el-button",{staticClass:"back-button",attrs:{type:"warning"},on:{click:t.handleBack}},[t._v("返回")])],1),e("p",{staticClass:"prompt-text"},[t._v("點選活動封面即可開始播放您的精彩回憶")]),e("el-row",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],attrs:{gutter:30}},t._l(t.activityList,function(i){return e("el-col",{key:i.id,staticClass:"activity-col",attrs:{span:8}},[e("el-card",{staticClass:"activity-card",attrs:{shadow:"hover"},nativeOn:{click:function(e){return t.handleSelectActivity(i)}}},[e("div",{staticClass:"activity-content"},[e("el-image",{staticClass:"activity-image",attrs:{src:i.cover||t.getDefaultCover(),fit:"cover"}},[e("div",{staticClass:"image-slot",attrs:{slot:"error"},slot:"error"},[e("i",{staticClass:"el-icon-picture-outline"})])]),e("div",{staticClass:"activity-info"},[e("p",{staticClass:"activity-name"},[t._v(t._s(i.name))]),e("p",{staticClass:"activity-date"},[e("i",{staticClass:"el-icon-date"}),t._v(" "+t._s(i.date)+" "),i.photoCount?e("span",[t._v(" ("+t._s(i.photoCount)+"張)")]):t._e()])])],1)])],1)}),1),t.loading||0!==t.activityList.length?t._e():e("el-empty",{attrs:{description:"目前尚無相關活動照片"}})],1)},m=[],g={name:"ActivityMenu",props:["rfid_uid"],data(){return{loading:!1,residentName:"",activityList:[]}},mounted(){this.rfid_uid?this.fetchDataByRfid():this.loadMockActivities()},methods:{getDefaultCover(){return"https://images.unsplash.com/photo-1516733725897-1aa73b87c8e8?w=600"},async fetchDataByRfid(){this.loading=!0;try{const t=await this.$http.get(`/api/rfid/${this.rfid_uid}`);if(t.data.match&&t.data.match.length>0){const e=t.data.match[0];this.residentName=e.name}t.data.activitys&&t.data.activitys.length>0&&(this.activityList=t.data.activitys.map(t=>({id:t.id,name:t.title,date:t.activity_at,cover:t.cover,photoCount:t.photo_count})))}catch(t){console.error("RFID 查詢失敗",t),this.$message.error("連線失敗，啟動示範模式"),this.loadMockActivities()}finally{this.loading=!1}},loadMockActivities(){this.residentName="示範長者",this.activityList=[{id:"2",name:"象棋大賽",date:"2025-12-18",photoCount:6,cover:"https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=600"},{id:"7",name:"話劇表演",date:"2025-12-24",photoCount:2,cover:"https://images.unsplash.com/photo-1576765608535-5f04d1e3f289?w=600"}]},handleSelectActivity(t){this.$emit("select-activity",{activityId:t.id,rfid:this.rfid_uid})},handleBack(){this.$emit("go-back")}}},v=g,f=(0,d.A)(v,p,m,!1,null,"7f99bd58",null),y=f.exports,_=function(){var t=this,e=t._self._c;return e("div",{staticClass:"slideshow-container"},[e("div",{staticClass:"header-playback"},[e("div",{staticClass:"title-group"},[e("h1",{staticClass:"main-title"},[t._v("回憶播放中")]),t.activityName?e("span",{staticClass:"activity-info"},[e("i",{staticClass:"el-icon-collection-tag"}),t._v(" "+t._s(t.activityName)+" ")]):t._e()]),e("el-button",{staticClass:"back-button",attrs:{type:"warning",icon:"el-icon-close"},on:{click:t.handleBack}},[t._v("結束放映")])],1),e("el-card",{staticClass:"slideshow-area",attrs:{shadow:"always"}},[e("div",{staticClass:"photo-display"},[t.photoList.length>1?e("div",{staticClass:"nav-arrow left-arrow",on:{click:t.prevPhoto}},[e("i",{staticClass:"el-icon-arrow-left"})]):t._e(),e("div",{staticClass:"current-photo-container"},[e("transition",{attrs:{name:"photo-fade",mode:"out-in"}},[t.photoList.length>0?e("el-image",{key:t.currentPhotoIndex,staticClass:"main-photo",attrs:{src:t.photoList[t.currentPhotoIndex].url,fit:"contain"}},[e("div",{staticClass:"image-loading",attrs:{slot:"placeholder"},slot:"placeholder"},[e("i",{staticClass:"el-icon-loading"}),t._v(" 正在翻開您的回憶錄... ")]),e("div",{staticClass:"image-error",attrs:{slot:"error"},slot:"error"},[e("i",{staticClass:"el-icon-picture-outline"}),t._v(" 哎呀，這段記憶暫時跑掉了 ")])]):t.loading?e("div",{staticClass:"current-photo-placeholder"},[e("i",{staticClass:"el-icon-loading"}),t._v(" 正在開啟時光機... ")]):e("div",{staticClass:"current-photo-placeholder"},[t._v("目前此活動尚無相關照片")])],1)],1),t.photoList.length>1?e("div",{staticClass:"nav-arrow right-arrow",on:{click:t.nextPhoto}},[e("i",{staticClass:"el-icon-arrow-right"})]):t._e()])]),e("div",{staticClass:"controls-bar"},[e("div",{staticClass:"control-panel"},[e("el-button",{staticClass:"play-btn",attrs:{type:t.isPlaying?"info":"warning",circle:"",icon:t.isPlaying?"el-icon-video-pause":"el-icon-video-play"},on:{click:t.togglePlay}}),e("div",{staticClass:"counter-badge"},[e("span",{staticClass:"current"},[t._v(t._s(t.photoList.length>0?t.currentPhotoIndex+1:0))]),e("span",{staticClass:"separator"},[t._v("/")]),e("span",{staticClass:"total"},[t._v(t._s(t.photoList.length))])])],1)])],1)},b=[],w={name:"Slideshow",props:["activityId","rfid_uid"],data(){return{loading:!1,isPlaying:!0,currentPhotoIndex:0,photoList:[],activityName:"",timer:null}},mounted(){this.fetchPhotos(),this.startTimer()},beforeDestroy(){this.stopTimer()},methods:{async fetchPhotos(){this.loading=!0;const t=localStorage.getItem("userToken");try{const e=await this.$http.get(`/api/activities/${this.activityId}/photos`,{params:{rfid:this.rfid_uid},headers:{Authorization:`Bearer ${t}`}});e.data.photos&&e.data.photos.length>0?(this.photoList=e.data.photos.map(t=>({id:t.id||t.photo_id,url:t.image_url||t.photo_url,taken_at:t.taken_at})),this.activityName=e.data.activity_title||`活動編號 #${this.activityId}`):this.loadMockPhotos()}catch(e){console.warn("API 抓取照片失敗 (測試 /api/ 路徑)，啟動示範模式"),this.loadMockPhotos()}finally{this.loading=!1}},loadMockPhotos(){this.activityName="時光記憶精選 (示範模式)";const t="/ccu-rfid-frontend/";this.photoList=[{url:`${t}slideshow/activity1.png`},{url:`${t}slideshow/activity2.png`},{url:`${t}slideshow/activity3.png`},{url:`${t}slideshow/activity4.png`}]},startTimer(){this.timer=setInterval(()=>{this.isPlaying&&this.photoList.length>1&&this.nextPhoto()},6e3)},stopTimer(){this.timer&&clearInterval(this.timer)},togglePlay(){this.isPlaying=!this.isPlaying},prevPhoto(){this.currentPhotoIndex=(this.currentPhotoIndex-1+this.photoList.length)%this.photoList.length},nextPhoto(){this.currentPhotoIndex=(this.currentPhotoIndex+1)%this.photoList.length},handleBack(){this.$emit("go-back")}}},C=w,k=(0,d.A)(C,_,b,!1,null,null,null),A=k.exports,I=function(){var t=this,e=t._self._c;return e("div",{staticClass:"login-wrapper"},[e("div",{staticClass:"login-box"},[t._m(0),e("el-card",{staticClass:"login-card",attrs:{shadow:"never"}},[e("div",{staticClass:"login-header",attrs:{slot:"header"},slot:"header"},[e("img",{staticClass:"login-logo",attrs:{src:"https://img.icons8.com/color/96/elderly-person.png",alt:"logo"}}),e("h2",[t._v("行政管理系統")]),e("p",{staticClass:"subtitle"},[t._v("請輸入您的管理員憑證")])]),e("el-form",{attrs:{model:t.loginForm,"label-position":"top"}},[e("el-form-item",{attrs:{label:"管理員帳號"}},[e("el-input",{attrs:{placeholder:"請輸入帳號 (ccu)","prefix-icon":"el-icon-user",clearable:""},model:{value:t.loginForm.account,callback:function(e){t.$set(t.loginForm,"account",e)},expression:"loginForm.account"}})],1),e("el-form-item",{attrs:{label:"管理密碼"}},[e("el-input",{attrs:{type:"password",placeholder:"請輸入密碼 (123)","prefix-icon":"el-icon-lock","show-password":""},nativeOn:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleLogin.apply(null,arguments)}},model:{value:t.loginForm.password,callback:function(e){t.$set(t.loginForm,"password",e)},expression:"loginForm.password"}})],1),e("el-button",{staticClass:"submit-btn",attrs:{type:"primary",loading:t.loading},on:{click:t.handleLogin}},[t._v(" 啟動管理平台 ")])],1)],1)],1)])},x=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"login-image-side"},[e("div",{staticClass:"side-bg"}),e("div",{staticClass:"overlay"},[e("h3",[t._v("智慧回憶錄")]),e("p",[t._v("用科技守護每一份珍貴的長者記憶")])])])}],$=i(4335),F={name:"Login",data(){return{loginForm:{account:"ccu",password:"123"},loading:!1}},methods:{async handleLogin(){if(this.loginForm.account&&this.loginForm.password){this.loading=!0;try{const t=await $.A.post("https://ccu-rfid-project-arhddfhugverf8dr.japanwest-01.azurewebsites.net/manager-api/Admin/login",this.loginForm);t.data&&t.data.access_token&&(localStorage.setItem("userToken",t.data.access_token),this.$message({message:"身份驗證成功，歡迎進入管理系統",type:"success",duration:2e3}),this.$emit("login-success"))}catch(t){console.error("Login Error:",t);const e=t.response?t.response.status:null;401===e?this.$message.error("帳號或密碼錯誤，請重新輸入"):this.$message.error("系統連線失敗，請檢查網路狀態")}finally{this.loading=!1}}else this.$message.warning("請完整輸入帳號密碼")}}},S=F,R=(0,d.A)(S,I,x,!1,null,"96d26702",null),E=R.exports,D=function(){var t=this,e=t._self._c;return e("div",{staticClass:"activity-list-container"},[e("div",{staticClass:"header-section"},[e("h2",[t._v("活動清單管理")]),e("el-button",{attrs:{type:"primary",icon:"el-icon-plus"},on:{click:function(e){return t.$emit("add-activity")}}},[t._v("新增活動")])],1),e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:t.activities,stripe:""}},[e("el-table-column",{attrs:{label:"活動封面",width:"120",align:"center"},scopedSlots:t._u([{key:"default",fn:function(t){return[e("el-image",{staticStyle:{width:"80px",height:"60px","border-radius":"6px",border:"1px solid #eee"},attrs:{src:t.row.cover||"https://images.unsplash.com/photo-1516733725897-1aa73b87c8e8?w=300",fit:"cover","preview-src-list":[t.row.cover]}},[e("div",{staticClass:"image-slot",attrs:{slot:"error"},slot:"error"},[e("i",{staticClass:"el-icon-picture-outline"})])])]}}])}),e("el-table-column",{attrs:{prop:"title",label:"活動名稱","min-width":"180"}}),e("el-table-column",{attrs:{prop:"activity_at",label:"活動日期",width:"120"}}),e("el-table-column",{attrs:{label:"RFID 綁定",width:"130",align:"center"},scopedSlots:t._u([{key:"default",fn:function(i){return[i.row.rfid?e("el-tag",{attrs:{type:"success",size:"small",effect:"plain"}},[e("i",{staticClass:"el-icon-postcard"}),t._v(" "+t._s(i.row.rfid)+" ")]):e("el-tag",{attrs:{type:"info",size:"small",effect:"plain"}},[t._v("未綁定")])]}}])}),e("el-table-column",{attrs:{prop:"location",label:"地點","min-width":"130"}}),e("el-table-column",{attrs:{prop:"photo_count",label:"照片數",width:"90",align:"center"}}),e("el-table-column",{attrs:{label:"操作",width:"120",align:"center"},scopedSlots:t._u([{key:"default",fn:function(i){return[e("el-button",{attrs:{type:"warning",size:"mini",icon:"el-icon-setting"},on:{click:function(e){return t.$emit("manage-activity",i.row.id)}}},[t._v(" 管理 ")])]}}])})],1)],1)},P=[],L={name:"ActivityList",data(){return{loading:!1,activities:[]}},mounted(){this.fetchActivities()},methods:{async fetchActivities(){this.loading=!0;const t=localStorage.getItem("userToken");try{const e=await $.A.get("https://ccu-rfid-project-arhddfhugverf8dr.japanwest-01.azurewebsites.net/manager-api/Activity",{headers:{Authorization:`Bearer ${t}`}});e.data&&e.data.length>0?this.activities=e.data:this.loadMockData()}catch(e){console.warn("API 連線失敗，載入示範資料"),this.loadMockData()}finally{this.loading=!1}},loadMockData(){this.activities=[{id:"demo_01",title:"象棋大賽暨腦力激盪",activity_at:"2025-12-18",location:"二樓多功能活動室",photo_count:24,rfid:"8A303053",cover:"https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=500"},{id:"demo_02",title:"冬至搓湯圓暖心活動",activity_at:"2025-12-21",location:"一樓共餐食堂",photo_count:18,rfid:"",cover:"https://images.unsplash.com/photo-1581579438747-104c53d7fbc4?w=500"}]}}},M=L,T=(0,d.A)(M,D,P,!1,null,"f9b2ae1c",null),V=T.exports,z=function(){var t=this,e=t._self._c;return e("div",{staticClass:"elder-list-container"},[e("div",{staticClass:"header-section",staticStyle:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"25px"}},[e("h2",{staticStyle:{"font-weight":"600",color:"#5d5146"}},[t._v("長者住民管理")]),e("el-button",{staticClass:"add-button",staticStyle:{"background-color":"#FF9933","border-color":"#FF9933","font-weight":"bold"},attrs:{type:"primary",icon:"el-icon-plus"},on:{click:function(e){return t.$emit("add-elder")}}},[t._v(" 新增長者住民 ")])],1),e("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"list-wrapper"},[e("el-table",{staticStyle:{width:"100%"},attrs:{data:t.elderList,stripe:""}},[e("el-table-column",{attrs:{label:"頭像",width:"100",align:"center"},scopedSlots:t._u([{key:"default",fn:function(i){return[e("el-avatar",{staticStyle:{border:"2px solid #f0e6da","background-color":"#eee"},attrs:{size:50,src:i.row.avatar||t.getDefaultAvatar()}},[t._v(" "+t._s(i.row.name?i.row.name.charAt(0):"U")+" ")])]}}])}),e("el-table-column",{attrs:{prop:"name",label:"姓名",width:"160"},scopedSlots:t._u([{key:"default",fn:function(i){return[e("span",{staticStyle:{"font-weight":"bold",color:"#333"}},[t._v(t._s(i.row.name))])]}}])}),e("el-table-column",{attrs:{prop:"age",label:"年齡",width:"100",align:"center"}}),e("el-table-column",{attrs:{prop:"rfid_uid",label:"RFID 卡號 (辨識 ID)","min-width":"150"},scopedSlots:t._u([{key:"default",fn:function(i){return[i.row.rfid_uid?e("el-tag",{attrs:{size:"medium",type:"success",effect:"plain"}},[e("i",{staticClass:"el-icon-postcard"}),t._v(" "+t._s(i.row.rfid_uid)+" ")]):e("el-tag",{attrs:{size:"medium",type:"info",effect:"plain"}},[t._v("尚未綁定")])]}}])}),e("el-table-column",{attrs:{label:"操作",width:"120",align:"center"},scopedSlots:t._u([{key:"default",fn:function(i){return[e("el-button",{staticStyle:{color:"#FF9933","font-weight":"bold"},attrs:{size:"mini",type:"text"},on:{click:function(e){return t.$emit("edit-elder",i.row.id)}}},[e("i",{staticClass:"el-icon-edit"}),t._v(" 編輯資料 ")])]}}])})],1),0!==t.elderList.length||t.loading?t._e():e("div",{staticClass:"empty-placeholder"},[e("i",{staticClass:"el-icon-user-solid",staticStyle:{"font-size":"48px",color:"#E4E7ED","margin-bottom":"15px"}}),e("p",[t._v("目前尚無長者登記資料")])])],1)])},N=[],B={name:"ElderList",data(){return{loading:!1,elderList:[]}},mounted(){this.fetchElders()},methods:{getDefaultAvatar(){return"https://images.unsplash.com/photo-1472393365320-dc77242e6ea2?auto=format&fit=crop&w=150&q=80"},async fetchElders(){this.loading=!0;const t=localStorage.getItem("userToken");if(!t)return this.setMockData(),void(this.loading=!1);try{const e=await this.$http.get("/manager-api/Resident",{headers:{Authorization:`Bearer ${t}`}});e.data&&e.data.length>0?this.elderList=e.data.map(t=>({id:t.id,name:t.name,age:t.age,rfid_uid:t.rfid_uid,avatar:t.avatar_url})):this.setMockData()}catch(e){console.warn("API 連線失敗，載入展示模式"),this.setMockData()}finally{this.loading=!1}},setMockData(){this.elderList=[{id:"m1",name:"James Wilson",age:82,rfid_uid:"116A2434",avatar:"https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?auto=format&fit=crop&w=150&q=80"},{id:"m2",name:"唐伯虎",age:75,rfid_uid:"8A303053",avatar:"https://images.unsplash.com/photo-1544144433-d50aff500b91?auto=format&fit=crop&w=150&q=80"}]}}},j=B,O=(0,d.A)(j,z,N,!1,null,"6c636a72",null),U=O.exports,G=function(){var t=this,e=t._self._c;return e("div",{staticClass:"elder-edit-container"},[e("div",{staticClass:"header-section"},[e("el-button",{attrs:{icon:"el-icon-back",circle:""},on:{click:function(e){return t.$emit("go-back")}}}),e("h2",{staticStyle:{"margin-left":"15px"}},[t._v(t._s(t.isEdit?"編輯長者住民資料":"新增長者住民入園登記"))])],1),e("el-card",{directives:[{name:"loading",rawName:"v-loading",value:t.submitting,expression:"submitting"}],staticClass:"edit-card",attrs:{shadow:"never"}},[e("el-form",{attrs:{model:t.elderForm,"label-position":"top"}},[e("el-row",{attrs:{gutter:40}},[e("el-col",{staticClass:"avatar-col",attrs:{span:8}},[e("div",{staticClass:"avatar-group"},[e("el-upload",{staticClass:"avatar-uploader",attrs:{action:"#","auto-upload":!1,"show-file-list":!1,"on-change":t.handleAvatarChange}},[t.imageUrl?e("div",{staticClass:"avatar-preview-wrapper"},[e("img",{staticClass:"avatar-preview",attrs:{src:t.imageUrl}}),e("div",{staticClass:"avatar-mask"},[e("i",{staticClass:"el-icon-edit"}),e("span",[t._v("更換照片")])])]):e("div",{staticClass:"uploader-placeholder"},[e("i",{staticClass:"el-icon-user avatar-uploader-icon"}),e("span",[t._v("上傳大頭照")])])]),e("div",{staticClass:"upload-guide"},[e("el-alert",{attrs:{title:"供 AI 臉部辨識基準",type:"info",closable:!1,"show-icon":"",center:""}}),e("p",{staticClass:"guide-text"},[t._v("請確保面部清晰無遮擋")])],1)],1)]),e("el-col",{attrs:{span:16}},[e("el-form-item",{attrs:{label:"住民姓名",required:""}},[e("el-input",{attrs:{placeholder:"例如：唐伯虎"},model:{value:t.elderForm.name,callback:function(e){t.$set(t.elderForm,"name",e)},expression:"elderForm.name"}})],1),e("el-row",{attrs:{gutter:20}},[e("el-col",{attrs:{span:12}},[e("el-form-item",{attrs:{label:"住民年齡"}},[e("el-input-number",{staticStyle:{width:"100%"},attrs:{min:60,max:120},model:{value:t.elderForm.age,callback:function(e){t.$set(t.elderForm,"age",e)},expression:"elderForm.age"}})],1)],1),e("el-col",{attrs:{span:12}},[e("el-form-item",{attrs:{label:"RFID 辨識編號"}},[e("el-input",{attrs:{placeholder:"請感應卡片系統自動帶入"},model:{value:t.elderForm.rfid_uid,callback:function(e){t.$set(t.elderForm,"rfid_uid",e)},expression:"elderForm.rfid_uid"}},[e("i",{staticClass:"el-icon-postcard",attrs:{slot:"prefix"},slot:"prefix"})])],1)],1)],1),e("el-form-item",{attrs:{label:"住民健康與生活備註"}},[e("el-input",{attrs:{type:"textarea",rows:"5"},model:{value:t.elderForm.remark,callback:function(e){t.$set(t.elderForm,"remark",e)},expression:"elderForm.remark"}})],1)],1)],1),e("div",{staticClass:"form-actions"},[e("el-button",{attrs:{type:"success",loading:t.submitting,icon:"el-icon-folder-checked"},on:{click:t.submitForm}},[t._v(" "+t._s(t.isEdit?"更新住民檔案":"確認入園並建立檔案")+" ")]),e("el-button",{on:{click:function(e){return t.$emit("go-back")}}},[t._v("取消返回")])],1)],1)],1)],1)},H=[],W={name:"ElderEdit",props:["elderId"],data(){return{elderForm:{name:"",age:80,rfid_uid:"",remark:""},imageUrl:"",selectedFile:null,submitting:!1,isEdit:!1}},mounted(){this.elderId&&(this.isEdit=!0,this.fetchElderData())},methods:{async fetchElderData(){const t=localStorage.getItem("userToken");try{const e=await this.$http.get(`/manager-api/Resident/${this.elderId}`,{headers:{Authorization:`Bearer ${t}`}});this.elderForm={name:e.data.name,age:e.data.age,rfid_uid:e.data.rfid_uid,remark:e.data.remark},this.imageUrl=e.data.avatar_url||""}catch(e){this.$message.error("讀取住民資料失敗")}},handleAvatarChange(t){this.selectedFile=t.raw,this.imageUrl=URL.createObjectURL(t.raw)},async submitForm(){if(!this.elderForm.name)return void this.$message.warning("請填寫住民姓名");this.submitting=!0;const t=localStorage.getItem("userToken"),e=new FormData;e.append("Name",this.elderForm.name),e.append("Age",this.elderForm.age),e.append("RfidUid",this.elderForm.rfid_uid),e.append("Remark",this.elderForm.remark),this.selectedFile&&e.append("Avatar",this.selectedFile);try{const i=this.isEdit?`https://ccu-rfid-project-arhddfhugverf8dr.japanwest-01.azurewebsites.net/manager-api/Resident/${this.elderId}`:"https://ccu-rfid-project-arhddfhugverf8dr.japanwest-01.azurewebsites.net/manager-api/Resident",a=this.isEdit?"put":"post";await(0,$.A)({method:a,url:i,data:e,headers:{Authorization:`Bearer ${t}`,"Content-Type":"multipart/form-data"}}),this.$message.success(this.isEdit?"資料更新成功":"入園登記成功"),this.$emit("go-back")}catch(i){this.$message.error("系統儲存失敗")}finally{this.submitting=!1}}}},q=W,J=(0,d.A)(q,G,H,!1,null,"42c2ca2e",null),K=J.exports,Q=function(){var t=this,e=t._self._c;return e("div",{staticClass:"ai-screening-container"},[e("div",{staticClass:"header-section"},[e("el-button",{attrs:{icon:"el-icon-back",circle:""},on:{click:function(e){return t.$emit("go-back")}}}),e("h2",{staticStyle:{"margin-left":"15px"}},[t._v("AI 分群結果審核")]),e("el-tag",{staticStyle:{"margin-left":"auto"},attrs:{type:"success",effect:"dark"}},[t._v("AI 運算完成 (100%)")])],1),e("el-alert",{staticStyle:{"margin-bottom":"20px"},attrs:{title:"提示：點擊照片可查看 AI 辨識橘框，若身分錯誤可於彈窗中進行修正。",type:"info","show-icon":"",closable:!1}}),e("el-row",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],attrs:{gutter:20}},t._l(t.aiGroups,function(i){return e("el-col",{key:i.resident_id,staticStyle:{"margin-bottom":"25px"},attrs:{span:24}},[e("el-card",{staticClass:"elder-group-card",attrs:{shadow:"hover"}},[e("div",{staticClass:"group-header",attrs:{slot:"header"},slot:"header"},[e("el-avatar",{attrs:{size:50,src:i.avatar,icon:"el-icon-user"}}),e("div",{staticClass:"elder-info"},[e("span",{staticClass:"elder-name"},[t._v(t._s(i.name))]),e("span",{staticClass:"match-rate"},[e("i",{staticClass:"el-icon-cpu"}),t._v(" AI 信心度: "+t._s((100*i.confidence).toFixed(1))+"%")])]),e("el-button",{staticStyle:{"margin-left":"auto"},attrs:{type:"primary",size:"small",plain:"",icon:"el-icon-check"}},[t._v("全組正確")])],1),e("div",{staticClass:"photo-grid"},t._l(i.photos,function(a,s){return e("div",{key:a.photo_id,staticClass:"photo-item",on:{click:function(e){return t.openEditDialog(a,i)}}},[e("el-image",{staticClass:"thumb-img",attrs:{src:a.photo_url,fit:"cover"}},[e("div",{staticClass:"image-slot-error",attrs:{slot:"error"},slot:"error"},[e("i",{staticClass:"el-icon-picture"})])]),e("div",{staticClass:"photo-action",on:{click:function(e){return e.stopPropagation(),t.removePhotoFromGroup(i,s)}}},[e("i",{staticClass:"el-icon-delete-solid"})])],1)}),0)])],1)}),1),e("el-dialog",{attrs:{title:"辨識內容校對",visible:t.editVisible,width:"600px","append-to-body":""},on:{"update:visible":function(e){t.editVisible=e}}},[t.editingPhoto?e("div",{staticClass:"edit-dialog-content"},[e("div",{staticClass:"preview-wrapper"},[e("img",{ref:"previewImg",staticClass:"preview-img",attrs:{src:t.editingPhoto.photo_url},on:{load:t.drawEditBox}}),e("div",{staticClass:"orange-box",style:t.boxStyle},[e("span",{staticClass:"box-label"},[t._v(t._s(t.editingPhoto.tempName))])])]),e("div",{staticClass:"edit-form"},[e("p",[t._v("AI 原始辨識為："),e("strong",[t._v(t._s(t.editingPhoto.originalName))])]),e("el-form",{attrs:{"label-position":"top"}},[e("el-form-item",{attrs:{label:"修正身分為："}},[e("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"請選擇正確長者"},on:{change:t.updateTempName},model:{value:t.editingPhoto.targetResidentId,callback:function(e){t.$set(t.editingPhoto,"targetResidentId",e)},expression:"editingPhoto.targetResidentId"}},t._l(t.residentOptions,function(t){return e("el-option",{key:t.id,attrs:{label:t.name,value:t.id}})}),1)],1)],1)],1)]):t._e(),e("span",{attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.editVisible=!1}}},[t._v("取消")]),e("el-button",{attrs:{type:"primary"},on:{click:t.confirmCorrection}},[t._v("確認修改")])],1)]),e("div",{staticClass:"bottom-actions"},[e("el-button",{attrs:{type:"success",size:"large",loading:t.loading,icon:"el-icon-document-checked"},on:{click:t.handleFinalSave}},[t._v(" 確認辨識結果並儲存至資料庫 ")])],1)],1)},X=[],Y={name:"AIScreening",props:["activityId"],data(){return{loading:!1,editVisible:!1,editingPhoto:null,boxStyle:{},aiGroups:[],residentOptions:[]}},methods:{async fetchScreeningResults(){this.loading=!0;try{const t=await this.$http.post(`/manager-api/Activity/${this.activityId}/recognize`);this.aiGroups=t.data,this.residentOptions=this.aiGroups.map(t=>({id:t.resident_id,name:t.name}))}catch(t){this.loadMockResults()}finally{this.loading=!1}},openEditDialog(t,e){this.editingPhoto={...t,originalGroup:e,originalName:e.name,targetResidentId:e.resident_id,tempName:e.name},this.editVisible=!0},drawEditBox(){const t=this.$refs.previewImg,e=this.editingPhoto.bounding_box;if(!t||!e)return;const i=t.clientWidth/t.naturalWidth,a=t.clientHeight/t.naturalHeight;this.boxStyle={top:e[0]*a+"px",left:e[1]*i+"px",width:(e[3]-e[1])*i+"px",height:(e[2]-e[0])*a+"px"}},updateTempName(t){this.editingPhoto.tempName=this.residentOptions.find(e=>e.id===t).name},confirmCorrection(){this.$message.success("已暫存修改，儲存後正式生效"),this.editVisible=!1},async handleFinalSave(){this.loading=!0;try{const t=[];this.aiGroups.forEach(e=>{e.photos.forEach(i=>{t.push({photo_id:i.photo_id,resident_id:e.resident_id})})}),await this.$http.post(`/manager-api/Activity/${this.activityId}/recognize/confirm`,t),this.$message.success("AI 辨識結果已同步至資料庫！"),this.$emit("go-back")}catch(t){this.$message.error("儲存失敗")}finally{this.loading=!1}},loadMockResults(){}}},Z=Y,tt=(0,d.A)(Z,Q,X,!1,null,"0568efa2",null),et=tt.exports,it=function(){var t=this,e=t._self._c;return e("div",{staticClass:"activity-manage-container"},[e("div",{staticClass:"header-section"},[e("el-button",{attrs:{icon:"el-icon-back",circle:""},on:{click:function(e){return t.$emit("go-back")}}}),e("h2",{staticStyle:{"margin-left":"15px"}},[t._v(t._s(t.isNewActivity?"建立活動檔案":"管理活動內容"))])],1),e("el-row",{attrs:{gutter:20}},[e("el-col",{attrs:{span:8}},[e("el-card",{directives:[{name:"loading",rawName:"v-loading",value:t.submitting,expression:"submitting"}],staticClass:"info-card",attrs:{shadow:"never"}},[e("div",{staticClass:"info-card-header",attrs:{slot:"header"},slot:"header"},[e("span",[e("i",{staticClass:"el-icon-collection-tag"}),t._v(" 活動基本設定")])]),e("el-form",{attrs:{model:t.activityForm,"label-position":"top"}},[e("el-form-item",{attrs:{label:"活動名稱"}},[e("el-input",{attrs:{placeholder:"例如：12月象棋大賽",disabled:!t.isNewActivity},model:{value:t.activityForm.title,callback:function(e){t.$set(t.activityForm,"title",e)},expression:"activityForm.title"}})],1),e("el-form-item",{attrs:{label:"RFID 實體卡綁定"}},[e("el-input",{attrs:{placeholder:"請掃描或輸入 RFID 序號",disabled:!t.isNewActivity,clearable:""},model:{value:t.activityForm.rfid,callback:function(e){t.$set(t.activityForm,"rfid",e)},expression:"activityForm.rfid"}},[e("i",{staticClass:"el-icon-postcard",attrs:{slot:"prefix"},slot:"prefix"})]),e("div",{staticClass:"form-tip"},[t._v("綁定後，長者掃描此卡可直接進入該活動相簿")])],1),e("el-form-item",{attrs:{label:"活動日期"}},[e("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"date",placeholder:"選擇活動日期","value-format":"yyyy-MM-dd",disabled:!t.isNewActivity},model:{value:t.activityForm.activity_at,callback:function(e){t.$set(t.activityForm,"activity_at",e)},expression:"activityForm.activity_at"}})],1),e("el-form-item",{attrs:{label:"活動地點"}},[e("el-input",{attrs:{placeholder:"例如：社區交誼廳",disabled:!t.isNewActivity},model:{value:t.activityForm.location,callback:function(e){t.$set(t.activityForm,"location",e)},expression:"activityForm.location"}})],1),t.isNewActivity?e("el-button",{staticStyle:{width:"100%","margin-top":"10px"},attrs:{type:"primary"},on:{click:t.handleCreateActivity}},[t._v("建立活動並開始上傳")]):t._e()],1),t.isNewActivity?t._e():e("div",{staticClass:"progress-section"},[e("el-divider"),e("p",{staticClass:"progress-text"},[e("i",{staticClass:"el-icon-cpu"}),t._v(" AI 人臉特徵掃描："+t._s(t.analyzedCount)+" / "+t._s(t.activityForm.photoCount)+" ")]),e("el-progress",{attrs:{percentage:t.progressPercentage,"stroke-width":18,color:t.customColors,striped:"","striped-flow":""}}),100===t.progressPercentage&&t.activityForm.photoCount>0?e("div",{staticClass:"ai-guide-box"},[e("el-alert",{attrs:{title:"掃描完成！AI 已自動識別長者身分",type:"success",closable:!1,"show-icon":""}}),e("div",{staticClass:"button-group"},[e("el-button",{staticClass:"manage-btn",attrs:{type:"primary",plain:"",icon:"el-icon-edit-outline"},on:{click:function(e){return t.$emit("go-screening")}}},[t._v("校對身分標籤")]),e("el-button",{staticClass:"pulse-btn",attrs:{type:"success",icon:"el-icon-picture"},on:{click:function(e){return t.$emit("go-recognition")}}},[t._v("查看 AI 辨識成果")])],1)],1):t._e()],1)],1)],1),e("el-col",{attrs:{span:16}},[e("el-card",{staticClass:"upload-card",class:{"disabled-overlay":t.isNewActivity},attrs:{shadow:"never"}},[e("div",{staticClass:"upload-header",attrs:{slot:"header"},slot:"header"},[e("span",[e("i",{staticClass:"el-icon-upload"}),t._v(" 批次照片上傳 (支援拖拽)")]),t.isNewActivity?e("el-tag",{attrs:{type:"warning",size:"small"}},[t._v("請先於左側儲存資訊")]):t._e()],1),t.isNewActivity?e("div",{staticClass:"upload-placeholder"},[e("div",{staticClass:"placeholder-icon-wrap"},[e("i",{staticClass:"el-icon-picture-outline",staticStyle:{"font-size":"60px"}})]),e("h3",[t._v("等待建立活動")]),e("p",[t._v("請先完成左側活動基本資訊，即可開啟雲端 AI 上傳通道")])]):e("el-upload",{attrs:{action:t.getUploadUrl(),name:"Files",headers:t.uploadHeaders,multiple:"","list-type":"picture-card","on-success":t.handleUploadSuccess,"on-error":t.handleUploadError}},[e("i",{staticClass:"el-icon-plus"})])],1)],1)],1)],1)},at=[],st={name:"ActivityManage",props:["selectedActivity"],data(){return{submitting:!1,isNewActivity:!this.selectedActivity?.id,activityForm:{id:this.selectedActivity?.id||null,title:this.selectedActivity?.title||"",activity_at:this.selectedActivity?.activity_at||"",location:this.selectedActivity?.location||"",rfid:this.selectedActivity?.rfid||"",photoCount:this.selectedActivity?.photo_count||0},analyzedCount:this.selectedActivity?.photo_count||0,uploadHeaders:{Authorization:`Bearer ${localStorage.getItem("userToken")}`},customColors:[{color:"#f56c6c",percentage:20},{color:"#67c23a",percentage:100}]}},computed:{progressPercentage(){return 0===this.activityForm.photoCount?0:Math.floor(this.analyzedCount/this.activityForm.photoCount*100)}},methods:{getUploadUrl(){return`https://ccu-rfid-project-arhddfhugverf8dr.japanwest-01.azurewebsites.net/manager-api/Activity/${this.activityForm.id}/UploadBatch`},async handleCreateActivity(){if(this.activityForm.title){this.submitting=!0;try{const t=await $.A.post("https://ccu-rfid-project-arhddfhugverf8dr.japanwest-01.azurewebsites.net/manager-api/Activity",this.activityForm,{headers:this.uploadHeaders});this.activityForm.id=t.data.id,this.isNewActivity=!1,this.$message.success("活動檔案已建立，且已綁定 RFID")}catch(t){this.$message.error("系統連線失敗")}finally{this.submitting=!1}}else this.$message.warning("請輸入活動名稱")},handleUploadSuccess(){this.$message.success("照片上傳成功"),this.activityForm.photoCount++,setTimeout(()=>{this.analyzedCount++},1500)},handleUploadError(){this.$message.error("上傳失敗")}}},ot=st,nt=(0,d.A)(ot,it,at,!1,null,"60e71ea8",null),rt=nt.exports,lt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"ai-recognition-container"},[e("div",{staticClass:"header-section"},[e("el-page-header",{attrs:{content:"AI 辨識結果預覽"},on:{back:function(e){return t.$emit("go-back")}}}),t.isDemoMode?e("el-tag",{staticClass:"demo-badge",attrs:{type:"warning",effect:"dark"}},[t._v("示範模式 (API 逾時)")]):t._e()],1),e("el-card",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"main-card"},[t.processedPhotos.length>0?e("div",{staticClass:"photo-grid"},t._l(t.processedPhotos,function(i){return e("div",{key:i.photo_id,staticClass:"photo-item"},[e("div",{staticClass:"image-wrapper"},[e("img",{ref:"img-"+i.photo_id,refInFor:!0,staticClass:"recognition-image",attrs:{src:i.photo_url},on:{load:function(e){return t.drawBoxes(i.photo_id)}}}),t._l(i.detections,function(i,a){return e("div",{key:a,staticClass:"face-box",style:i.boxStyle,on:{click:function(e){return t.openCorrectionDialog(i)}}},[e("span",{staticClass:"name-label",class:{"is-edited":i.isEdited}},[t._v(" "+t._s(i.resident_name)+" ("+t._s((100*i.confidence).toFixed(0))+"%) ")])])})],2)])}),0):t.loading?t._e():e("div",{staticClass:"empty-state"},[e("el-empty",{attrs:{description:"目前該活動尚未有辨識資料"}})],1),e("div",{staticClass:"action-bar"},[e("el-button",{attrs:{type:"success",size:"large",icon:"el-icon-check",loading:t.submitting},on:{click:t.handleConfirm}},[t._v(" 確認並正式存檔 ")])],1)]),e("el-dialog",{attrs:{title:"修正辨識結果",visible:t.dialogVisible,width:"30%"},on:{"update:visible":function(e){t.dialogVisible=e}}},[e("el-form",{attrs:{"label-width":"80px"}},[e("el-form-item",{attrs:{label:"正確長者"}},[e("el-select",{attrs:{filterable:"",placeholder:"請選擇長者"},model:{value:t.selectedResidentId,callback:function(e){t.selectedResidentId=e},expression:"selectedResidentId"}},t._l(t.allResidents,function(t){return e("el-option",{key:t.id,attrs:{label:t.name,value:t.id}})}),1)],1)],1),e("span",{attrs:{slot:"footer"},slot:"footer"},[e("el-button",{on:{click:function(e){t.dialogVisible=!1}}},[t._v("取消")]),e("el-button",{attrs:{type:"primary"},on:{click:t.saveTempCorrection}},[t._v("暫存修改")])],1)],1)],1)},ct=[],dt={name:"AIRecognitionView",props:["activityId"],data(){return{loading:!1,submitting:!1,isDemoMode:!1,rawResults:[],processedPhotos:[],dialogVisible:!1,allResidents:[],currentDet:{},selectedResidentId:""}},mounted(){this.$nextTick(()=>{this.fetchAIResults()}),window.addEventListener("resize",this.refreshBoxes)},beforeDestroy(){window.removeEventListener("resize",this.refreshBoxes)},methods:{async fetchAIResults(){this.loading=!0,this.isDemoMode=!1;const t=localStorage.getItem("userToken");try{const e=await this.$http.post(`/Activity/${this.activityId}/recognize`,{},{headers:{Authorization:`Bearer ${t}`},timeout:3e4});e.data&&e.data.length>0?this.rawResults=e.data:this.loadMockData()}catch(e){console.warn("API 抓取失敗，啟動多樣化示範模式",e),this.loadMockData()}finally{this.processData(),this.loading=!1}},loadMockData(){this.isDemoMode=!0,this.rawResults=[{resident_id:"3",resident_name:"唐伯虎",confidence:.92,photos:[{photo_id:999,photo_url:"https://picsum.photos/id/237/800/600",bounding_box:[150,200,450,500]}]},{resident_id:"5",resident_name:"秋香",confidence:.88,photos:[{photo_id:888,photo_url:"https://picsum.photos/id/1025/800/600",bounding_box:[100,300,400,600]}]}]},processData(){const t={};this.rawResults.forEach(e=>{e.photos.forEach(i=>{t[i.photo_id]||(t[i.photo_id]={photo_id:i.photo_id,photo_url:i.photo_url,detections:[]}),t[i.photo_id].detections.push({resident_id:e.resident_id,resident_name:e.resident_name,confidence:e.confidence,rawBox:i.bounding_box,boxStyle:{},isEdited:!1})})}),this.processedPhotos=Object.values(t)},drawBoxes(t){this.$nextTick(()=>{const e=this.$refs["img-"+t],i=Array.isArray(e)?e[0]:e,a=this.processedPhotos.find(e=>e.photo_id===t);if(!i||!a||0===i.naturalWidth)return;const s=i.clientWidth/i.naturalWidth,o=i.clientHeight/i.naturalHeight;a.detections.forEach(t=>{const[e,i,a,n]=t.rawBox;t.boxStyle={top:e*o+"px",left:i*s+"px",width:(n-i)*s+"px",height:(a-e)*o+"px"}}),this.$forceUpdate()})},refreshBoxes(){setTimeout(()=>{this.processedPhotos.forEach(t=>this.drawBoxes(t.photo_id))},200)},async openCorrectionDialog(t){this.currentDet=t,this.selectedResidentId=t.resident_id,this.dialogVisible=!0,0===this.allResidents.length&&await this.fetchAllResidents()},async fetchAllResidents(){try{const t=localStorage.getItem("userToken"),e=await this.$http.get("/Resident",{headers:{Authorization:`Bearer ${t}`}});this.allResidents=e.data}catch(t){this.$message.error("無法獲取長者清單")}},saveTempCorrection(){const t=this.allResidents.find(t=>t.id===this.selectedResidentId);t&&(this.currentDet.resident_id=t.id,this.currentDet.resident_name=t.name,this.currentDet.isEdited=!0,this.$message({message:"修改已暫存",type:"info",duration:1500})),this.dialogVisible=!1},async handleConfirm(){try{await this.$confirm("確認所有辨識結果正確嗎？","存檔確認",{type:"success"}),this.submitting=!0;const t=[];this.processedPhotos.forEach(e=>{e.detections.forEach(i=>{t.push({photo_id:e.photo_id,resident_id:i.resident_id})})});const e=localStorage.getItem("userToken");await this.$http.post(`/Activity/${this.activityId}/recognize/confirm`,t,{headers:{Authorization:`Bearer ${e}`}}),this.$message.success("辨識結果已同步！"),this.$emit("go-back")}catch(t){"cancel"!==t&&this.$message.error("儲存失敗")}finally{this.submitting=!1}}}},ut=dt,ht=(0,d.A)(ut,lt,ct,!1,null,"26b89f3b",null),pt=ht.exports,mt={name:"App",components:{RFIDLanding:h,ActivityMenu:y,Slideshow:A,Login:E,ActivityList:V,ElderList:U,ElderEdit:K,AIScreening:et,ActivityManage:rt,AIRecognitionView:pt},data(){return{currentView:"RFIDLanding",debugMode:!0,selectedRfid:null,selectedResidentId:null,selectedActivityId:null,activeActivityObject:null}},computed:{isAdminView(){const t=["ActivityList","ElderList","ActivityManage","ElderEdit","AIScreening","AIRecognition"];return t.includes(this.currentView)}},methods:{onScanSuccess(t){this.selectedRfid=t.rfid,t.match&&"activity"===t.match.type?(this.selectedActivityId=t.match.id,this.currentView="Slideshow"):this.currentView="ActivityMenu"},onSelectActivity(t){this.selectedActivityId=t.activityId,this.selectedRfid=t.rfid,this.currentView="Slideshow"},onManageActivity(t){this.selectedActivityId=t,this.activeActivityObject={id:t},this.currentView="ActivityManage"},onAddActivity(){this.selectedActivityId=null,this.activeActivityObject=null,this.currentView="ActivityManage"},onEditElder(t){this.selectedResidentId=t,this.currentView="ElderEdit"},onAddElder(){this.selectedResidentId=null,this.currentView="ElderEdit"},logout(){localStorage.removeItem("userToken"),this.currentView="Login",this.$message.info("已安全登出")}}},gt=mt,vt=(0,d.A)(gt,s,o,!1,null,null,null),ft=vt.exports,yt=i(1052),_t=i.n(yt),bt=i(173);a["default"].config.productionTip=!1,a["default"].use(_t()),a["default"].use(bt.Ay);const wt=[{path:"/activity/:activityId/ai",name:"AIRecognition",component:pt,props:!0}],Ct=new bt.Ay({mode:"hash",base:"/ccu-rfid-frontend/",routes:wt}),kt=$.A.create({baseURL:"https://ccu-rfid-project-arhddfhugverf8dr.japanwest-01.azurewebsites.net/manager-api",timeout:3e4,withCredentials:!1});kt.interceptors.request.use(t=>{const e=localStorage.getItem("userToken");return e&&(t.headers.Authorization=`Bearer ${e}`),t},t=>Promise.reject(t)),a["default"].prototype.$http=kt,new a["default"]({router:Ct,render:t=>t(ft)}).$mount("#app")}},e={};function i(a){var s=e[a];if(void 0!==s)return s.exports;var o=e[a]={id:a,loaded:!1,exports:{}};return t[a](o,o.exports,i),o.loaded=!0,o.exports}i.m=t,function(){i.amdO={}}(),function(){var t=[];i.O=function(e,a,s,o){if(!a){var n=1/0;for(d=0;d<t.length;d++){a=t[d][0],s=t[d][1],o=t[d][2];for(var r=!0,l=0;l<a.length;l++)(!1&o||n>=o)&&Object.keys(i.O).every(function(t){return i.O[t](a[l])})?a.splice(l--,1):(r=!1,o<n&&(n=o));if(r){t.splice(d--,1);var c=s();void 0!==c&&(e=c)}}return e}o=o||0;for(var d=t.length;d>0&&t[d-1][2]>o;d--)t[d]=t[d-1];t[d]=[a,s,o]}}(),function(){i.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return i.d(e,{a:e}),e}}(),function(){i.d=function(t,e){for(var a in e)i.o(e,a)&&!i.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})}}(),function(){i.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){i.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}}(),function(){i.nmd=function(t){return t.paths=[],t.children||(t.children=[]),t}}(),function(){var t={524:0};i.O.j=function(e){return 0===t[e]};var e=function(e,a){var s,o,n=a[0],r=a[1],l=a[2],c=0;if(n.some(function(e){return 0!==t[e]})){for(s in r)i.o(r,s)&&(i.m[s]=r[s]);if(l)var d=l(i)}for(e&&e(a);c<n.length;c++)o=n[c],i.o(t,o)&&t[o]&&t[o][0](),t[o]=0;return i.O(d)},a=self["webpackChunkccu_rfid_frontend"]=self["webpackChunkccu_rfid_frontend"]||[];a.forEach(e.bind(null,0)),a.push=e.bind(null,a.push.bind(a))}();var a=i.O(void 0,[504],function(){return i(8157)});a=i.O(a)})();
//# sourceMappingURL=app.0e88fb46.js.map